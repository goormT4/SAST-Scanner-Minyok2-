name: Semgrep

on:
  push:
    branches: [ main, master, develop ]
  pull_request:
    branches: [ main, master, develop ]

permissions:
  contents: read
  security-events: write
  pull-requests: write

jobs:
  semgrep:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # (ë””ë²„ê·¸) ì‹¤ì œë¡œ ìŠ¤ìº”ë  PHP íŒŒì¼ í™•ì¸
      - name: List PHP files
        run: |
          echo "Repo root: $PWD"
          find . -type f -name "*.php" | head -n 200
          echo "Total PHP files:"
          find . -type f -name "*.php" | wc -l

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Semgrep & jq
        run: |
          pip install --upgrade pip semgrep
          sudo apt-get update && sudo apt-get install -y jq

      # ì„¤ì • íŒŒì¼(.semgrep/.semgrep.yml â†’ .semgrep.yml â†’ auto) ê°ì§€ + ë¦¬í¬íŠ¸ í´ë” ì¤€ë¹„
      - name: Prepare config & reports dir
        run: |
          if [ -f ".semgrep/.semgrep.yml" ]; then
            echo "CONFIG=.semgrep/.semgrep.yml" >> $GITHUB_ENV
          elif [ -f ".semgrep.yml" ]; then
            echo "CONFIG=.semgrep.yml" >> $GITHUB_ENV
          else
            echo "CONFIG=auto" >> $GITHUB_ENV
          fi
          mkdir -p reports

      # âš ï¸ JSONê³¼ SARIFëŠ” í•œ ë²ˆì— ì¶œë ¥ ë¶ˆê°€ â†’ ë‘ ë²ˆ ìŠ¤ìº”
      - name: Semgrep JSON
        run: |
          semgrep scan --config "$CONFIG" \
            --metrics=off --timeout 10 \
            --json -o reports/semgrep.json || true

      - name: Semgrep SARIF
        run: |
          semgrep scan --config "$CONFIG" \
            --metrics=off --timeout 10 \
            --sarif -o reports/semgrep.sarif || true

      # GitHub Actions Job Summaryì— í•­ìƒ ìš”ì•½ ì¶œë ¥
      - name: Write Markdown Summary
        if: always()
        run: |
          echo "## ğŸ§ª Semgrep Summary" >> $GITHUB_STEP_SUMMARY

          if [ -s reports/semgrep.json ]; then
            TOTAL=$(jq '.results | length' reports/semgrep.json)
            echo "- Total findings: **$TOTAL**" >> $GITHUB_STEP_SUMMARY

            for sev in ERROR WARNING INFO; do
              COUNT=$(jq --arg sev "$sev" '[.results[] | select(.extra.severity==$sev)] | length' reports/semgrep.json)
              echo "  - $sev: **$COUNT**" >> $GITHUB_STEP_SUMMARY
            done

            echo -e "\n### Top findings (up to 10)\n" >> $GITHUB_STEP_SUMMARY
            jq -r '
              .results[]
              | {check_id, path: .path, start: .start.line, message: .extra.message, severity: .extra.severity}
              | "| \(.severity) | \(.check_id) | \(.path):\(.start) | \(.message | gsub("\\n"; " ")) |"
            ' reports/semgrep.json | head -n 10 >> $GITHUB_STEP_SUMMARY
          else
            echo "- Semgrep produced no JSON (likely no files matched). Check the **List PHP files** step above." >> $GITHUB_STEP_SUMMARY
          fi

      # Code Scanningì— SARIF ì—…ë¡œë“œ (ì•ŒëŸ¿ 0ì´ì–´ë„ ì‹œë„)
      - name: Upload SARIF
        if: always()
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/semgrep.sarif

      # ë¦¬í¬íŠ¸ íŒŒì¼ ë³´ì¡´(ë‹¤ìš´ë¡œë“œìš©)
      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-reports
          path: reports/*
          if-no-files-found: warn
          retention-days: 14
